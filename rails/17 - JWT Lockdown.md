

### Step 1: Replace controller content
```
#### app/controllers/graphql_controller.rb

# Change `RailsApiSchema` below to match what you have in app/graphql/xx_schema.rb file, the class definition:

# frozen_string_literal: true

class GraphqlController < ApplicationController
  before_action :authenticate_user!, unless: -> { graphql_authentication_action? }

  def execute
    variables = prepare_variables(params[:variables])
    query = params[:query]
    operation_name = params[:operationName]
    context = {
      current_user: set_current_user,
      jwt_token: request.headers['Authorization']&.split(' ')&.last
    }

    result = RailsApiSchema.execute(query, variables: variables, context: context, operation_name: operation_name)
    render json: result
  rescue StandardError => e
    raise e unless Rails.env.development?
    handle_error_in_development(e)
  end

  private

  def authenticate_user!
    token = request.headers['Authorization']&.split(' ')&.last
    unless token
      render json: { error: 'Unauthorized' }, status: :unauthorized
      return
    end

    begin
      jwt_payload = JWT.decode(token, Rails.application.credentials.jwt_secret_key).first
      @current_user = User.find(jwt_payload['sub'])
    rescue JWT::DecodeError
      render json: { error: 'Invalid token' }, status: :unauthorized
    rescue ActiveRecord::RecordNotFound
      render json: { error: 'User not found' }, status: :unauthorized
    end
  end

  def set_current_user
    token = request.headers['Authorization']&.split(' ')&.last
    return nil unless token

    begin
      jwt_payload = JWT.decode(token, Rails.application.credentials.jwt_secret_key).first
      User.find(jwt_payload['sub'])
    rescue JWT::DecodeError, ActiveRecord::RecordNotFound
      nil
    end
  end

  def graphql_authentication_action?
    sign_up_query? || sign_in_query?
  end

  def sign_up_query?
    params[:query]&.include?('signUp')
  end

  def sign_in_query?
    params[:query]&.include?('signIn')
  end

  def prepare_variables(variables_param)
    case variables_param
    when String
      if variables_param.present?
        JSON.parse(variables_param) || {}
      else
        {}
      end
    when Hash
      variables_param
    when ActionController::Parameters
      variables_param.to_unsafe_hash
    when nil
      {}
    else
      raise ArgumentError, "Unexpected parameter: #{variables_param}"
    end
  end

  def handle_error_in_development(e)
    logger.error e.message
    logger.error e.backtrace.join("\n")
    render json: { error: { message: e.message, backtrace: e.backtrace }, data: {} }, status: 500
  end
end
```

### Step 2: Understanding changes to controller
```
# Differences from the code generated by a generator:

- `before_action :authenticate_user!, unless: -> { graphql_authentication_action? }`:
  - Adds a before_action callback to authenticate the user unless the request is for a specific authentication action (sign up or sign in).
  - Ensures that authentication is skipped for specific GraphQL actions that don't require the user to be authenticated.

- `context = { current_user: set_current_user, jwt_token: request.headers['Authorization']&.split(' ')&.last }`:
  - Adds `current_user` and `jwt_token` to the context used in GraphQL execution.
  - This context is passed to the GraphQL resolvers, allowing them to access the current user and JWT token.

- `authenticate_user!` method:
  - Custom method to authenticate the user using JWT. 
  - Decodes the token from the Authorization header and sets the current user.
  - Renders an unauthorized error if the token is invalid or the user is not found.

- `set_current_user` method:
  - Custom method to decode the JWT token and set the current user.
  - Returns `nil` if the token is invalid or the user is not found.
  - Used to set the current user in the GraphQL context.

- `graphql_authentication_action?`, `sign_up_query?`, and `sign_in_query?` methods:
  - Custom methods to check if the current query is for signing up or signing in.
  - These methods are used to determine whether to skip authentication for the current request.
  - Helps in conditionally applying authentication logic based on the type of GraphQL action.

- `prepare_variables` method:
  - Custom method to handle different types of variables input (String, Hash, ActionController::Parameters, nil).
  - Converts the input variables to a suitable format for GraphQL execution.
  - Ensures that variables are properly parsed and handled.

- `handle_error_in_development` method:
  - Custom error handling for development environment.
  - Logs the error message and backtrace.
  - Returns a detailed error message in the JSON response, useful for debugging during development.

# Questions:
# 1. What is the purpose of the `before_action :authenticate_user!, unless: -> { graphql_authentication_action? }` callback in the controller?
# 2. How does the `context` hash enhance the functionality of GraphQL resolvers with `current_user` and `jwt_token`?
# 3. What are the roles of the `authenticate_user!` and `set_current_user` methods in handling JWT authentication?
# 4. How do the `graphql_authentication_action?`, `sign_up_query?`, and `sign_in_query?` methods contribute to the authentication logic in GraphQL requests?

```
